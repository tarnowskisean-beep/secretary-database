// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Entity {
  id                String   @id @default(uuid())
  legalName         String
  ein               String?  @unique
  entityType        String
  taxClassification String?
  stateOfIncorporation String?
  fiscalYearEnd     String?
  logoUrl           String?  // URL to company logo
  
  // Governance
  parentAppointsGoverningBody Boolean @default(false) // Does the parent have power to appoint the board?
  
  // Schedule R Specifics
  supportingOrgType   String?   // For Part I: TYPE_I, TYPE_II, TYPE_III_FI, TYPE_III_NFI
  
  // Schedule R Columns
  primaryActivity     String?   // Part I-VI, Col (b) e.g., "Investment", "Program Services"
  legalDomicile       String?   // Part I-VI, Col (e) State or Country
  exemptCodeSection   String?   // Part II, Col (d) e.g., "501(c)(3)"
  publicCharityStatus String?   // Part II, Col (e) e.g., "170(b)(1)(A)(vi)"
  isSection512Controlled Boolean? // Part II, Col (g)
  
  // Part III/IV Financials
  predominantIncomeType    String? // Part III, Col (h) "Investment" or "Program"
  shareOfTotalIncome       Float?  // Part III/IV, Col (i)
  shareOfEndOfYearAssets   Float?  // Part III/IV, Col (j)
  disproportionateAllocation Boolean? // Part III, Col (k)
  ubtiAmount               Float?  // Part III, Col (l) - Unrelated Business Taxable Income
  isGeneralPartner         Boolean? // Part III, Col (m)

  // Relations
  owners            EntityOwner[] @relation("ChildEntity")
  subsidiaries      EntityOwner[] @relation("OwnerEntity")

  roles             BoardRole[]
  
  // Transactions (Part V)
  transactionsOut   RelatedTransaction[] @relation("FromEntity")
  transactionsIn    RelatedTransaction[] @relation("ToEntity")

  nameChanges       NameChange[]
  attachments       Attachment[]
  annualReports     AnnualReport[]

  // Recurring Tracking Configurations
  hasRecurringAnnualReport Boolean @default(false)
  recurringReportFrequency String? @default("ANNUAL") // ANNUAL, BIANNUAL, QUARTERLY, MONTHLY
  recurringReportDueMonth  Int?    // 1-12
  recurringReportDueDay    Int?    // 1-31

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([legalName])
}

// ... (Entity model remains same)

model EntityOwner {
  id            String   @id @default(uuid())
  
  childEntityId String
  childEntity   Entity   @relation("ChildEntity", fields: [childEntityId], references: [id], onDelete: Cascade)
  
  ownerEntityId String?
  ownerEntity   Entity?   @relation("OwnerEntity", fields: [ownerEntityId], references: [id], onDelete: Cascade)
  
  ownerPersonId String?
  ownerPerson   Person?   @relation("PersonOwner", fields: [ownerPersonId], references: [id], onDelete: Cascade)
  
  percentage    Float    // Ownership percentage
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([childEntityId, ownerEntityId, ownerPersonId]) // Prevent duplicate ownership records
}

model Person {
  id          String   @id @default(uuid())
  firstName   String
  lastName    String
  internalId  String?  @unique
  
  // Contact & Governance
  email       String?
  phone       String?
  mailingAddress String?
  
  aliases     PersonAlias[]

  roles       BoardRole[]
  
  relationshipsAsPerson1 Relationship[] @relation("Person1")
  relationshipsAsPerson2 Relationship[] @relation("Person2")

  ownerships  EntityOwner[] @relation("PersonOwner")
  nameChanges NameChange[]
  attachments Attachment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([lastName, firstName])
}

model PersonAlias {
  id        String @id @default(uuid())
  personId  String
  person    Person @relation(fields: [personId], references: [id], onDelete: Cascade)
  alias     String
}

model BoardRole {
  id            String    @id @default(uuid())

  personId      String
  person        Person    @relation(fields: [personId], references: [id], onDelete: Cascade)

  entityId      String
  entity        Entity    @relation(fields: [entityId], references: [id], onDelete: Cascade)

  title         String
  roleType      String
  startDate     DateTime?
  endDate       DateTime?

  votingRights  Boolean   @default(true)
  isCompensated Boolean   @default(false)

  appointmentDocUrl String? // URL to board resolution appointing this role
  resignationDocUrl String? // URL to resignation letter or board resolution ending this role

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([personId])
  @@index([entityId])
}

model Relationship {
  id        String   @id @default(uuid())
  person1Id String
  person1   Person   @relation("Person1", fields: [person1Id], references: [id], onDelete: Cascade)
  person2Id String
  person2   Person   @relation("Person2", fields: [person2Id], references: [id], onDelete: Cascade)
  
  type      String   // FAMILY, BUSINESS, OTHER
  details   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([person1Id])
  @@index([person2Id])
}

model RelatedTransaction {
  id            String   @id @default(uuid())
  
  fromEntityId  String
  fromEntity    Entity   @relation("FromEntity", fields: [fromEntityId], references: [id], onDelete: Cascade)
  
  toEntityId    String
  toEntity      Entity   @relation("ToEntity", fields: [toEntityId], references: [id], onDelete: Cascade)

  type          String   // LOAN, GRANT, SHARED_SERVICES, ASSET_ALE, ETC
  amount        Float?
  description   String?
  date          DateTime @default(now()) // Transaction date or fiscal year end

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([fromEntityId])
  @@index([toEntityId])
}

enum UserRole {
  ADMIN
  EDITOR
  VIEWER
}

model User {
  id            String    @id // Supabase Auth ID
  email         String    @unique
  role          UserRole  @default(VIEWER)
  
  lastLogin     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  auditLogs     AuditLog[]
}

model AuditLog {
  id            String   @id @default(uuid())
  
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  
  action        String   // "CREATE", "UPDATE", "DELETE", "LOGIN"
  resource      String   // "Entity", "Person", "BoardRole"
  resourceId    String?  // ID of the object changed
  details       String?  // JSON string or summary of change
  
  ipAddress     String?
  userAgent     String?

  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([resource])
  @@index([createdAt])
}

model NameChange {
  id          String   @id @default(uuid())
  
  // Polymorphic-style relation (one must be set)
  personId    String?
  person      Person?  @relation(fields: [personId], references: [id], onDelete: Cascade)
  
  entityId    String?
  entity      Entity?  @relation(fields: [entityId], references: [id], onDelete: Cascade)
  
  oldName     String
  newName     String
  documentUrl String?  // URL/Base64 of the supporting PDF/Image
  
  changedBy   String?  // User ID who made the change
  changeDate  DateTime @default(now()) // When the change happened successfully
  effectiveDate DateTime? // Optional: When the name change is legally effective
  
  createdAt   DateTime @default(now())
  
  @@index([personId])
  @@index([entityId])
}

model Attachment {
  id          String   @id @default(uuid())
  
  // Polymorphic-style relation
  personId    String?
  person      Person?  @relation(fields: [personId], references: [id], onDelete: Cascade)
  
  entityId    String?
  entity      Entity?  @relation(fields: [entityId], references: [id], onDelete: Cascade)
  
  title       String   
  url         String   
  type        String   @default("LINK") // "LINK", "FILE"
  
  createdAt   DateTime @default(now())
  
  @@index([personId])
  @@index([entityId])
}

model AnnualReport {
  id          String   @id @default(uuid())
  
  entityId    String
  entity      Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)
  
  year        String   // e.g. "2024"
  status      String   @default("PENDING") // PENDING, FILED, OVERDUE, EXEMPT
  dueDate     DateTime?
  filingDate  DateTime?
  documentUrl String?
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([entityId])
  @@index([year])
  @@index([status])
}
